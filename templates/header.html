<!doctype html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.bundle.min.js"></script>
  <script src="https://kit.fontawesome.com/5135d630a7.js" crossorigin="anonymous"></script>
  <style>
      .dropdown-menu {
          z-index: 2000 !important; /* Ensure it's on top of other elements */
          display: block;
          visibility: hidden;
      }
      .dropdown-menu.show {
          visibility: visible;
      }
      .submenu {
          color: black;
          text-decoration: none;
      }
      .submenu:hover {
          color: rgb(110, 139, 149);
          text-decoration: none;
      }
      .notification {
          background-color: transparent; /* Changed for icon */
          color: white;
          padding: 4px;
          margin: 0 10px;
          position: relative;
          display: inline-block;
          border-radius: 2px;
          font-size: 20px;
      }
      .notification:hover {
          color: #0b5ed7;
      }
      .notification .badge {
          position: absolute;
          top: -10px;
          right: -10px;
          padding: 5px 10px;
          border-radius: 50%;
          background: red;
          color: white;
      }
      .notification .fa-bell {
        color: black; /* Change bell icon color to black */
      }
  </style>
</head>
<body style="background-color: rgb(247, 239, 215)">
  <div class="container">
      {% if request.user.is_authenticated %}
      <div class="d-flex justify-content-end align-items-center">
        
          <a class="submenu" href="{% url 'baseapp:order_history' request.user.username %}">
              <span class="uil uil-bill"></span>
              <span>Orders</span>
          </a>
          <a class="ms-2 ms-md-3 submenu" href="{% url 'baseapp:upload_history' request.user.username %}">
                <span class="uil uil-file-heart"></span>
                <span class="ms-1 fs-10 fs-sm-9">Uploads</span>
          </a>
          <a class="ms-2 ms-md-3 submenu" href="{% url 'baseapp:cart' %}"
                ><span class="uil uil-shopping-cart"></span
                ><span class="ms-1 fs-10 fs-sm-9">Cart</span>
          </a>
          
          <!-- Notification Dropdown -->
          <div class="dropdown">
            <a class="notification" href="#" id="dropdownMenuLink1" data-bs-toggle="dropdown" aria-expanded="false">
                <i class='fas fa-bell'></i> <!-- Bell icon -->
                <span class="badge">{{ unread_count }}</span> <!-- Dynamically rendered -->
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink1">
                {% for i in notifications %}
                <li><a class="dropdown-item" href="#">{{ i.message }}</a></li>
                {% endfor %}
            </ul>
          </div>
          
          <!-- Account Dropdown -->
          <div class="dropdown">
              <a class="submenu dropdown-toggle" href="#" role="button" id="dropdownMenuLink2" data-bs-toggle="dropdown" aria-expanded="false">
                  <span class="uil uil-user-circle"></span>
                  <span>Account</span>
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink2">
                  <li><a class="dropdown-item" href="{% url 'baseapp:user_profile' request.user.username %}">My Profile</a></li>
                  <li><a class="dropdown-item" href="{% url 'baseapp:change_password' %}">Change Password</a></li>
                  <li><a class="dropdown-item" href="{% url 'baseapp:upload_history' request.user.username %}">Upload History</a></li>
                  <li><a class="dropdown-item" href="{% url 'baseapp:signout' %}">Logout</a></li>
              </ul>
          </div>
        </div>              
            {% else %}
            <div class="d-flex justify-content-end align-items-center">
              <!-- <a class="ms-2 ms-md-3 submenu" href="#!"
                ><span class="uil uil-bill"></span
                ><span class="ms-1 fs-10 fs-sm-9">sale</span></a
              ><a class="ms-2 ms-md-3 submenu" href="#!"
                ><span class="uil uil-file-heart"></span
                ><span class="ms-1 fs-10 fs-sm-9">wishlist</span></a> -->
              <a class="ms-2 ms-md-3 submenu" href="#!"
                ><span class="uil uil-shopping-cart"></span
                ><span class="ms-1 fs-10 fs-sm-9">cart</span>
              </a>
              <a class="ms-2 ms-md-3 submenu" href="{% url 'baseapp:signin' %}"
                ><span class="uil uil-user-circle"></span
                ><span class="ms-1 fs-10 fs-sm-9">Login/Sign Up</span>
              </a>
              {% endif %}
            </div>
          </div>
          <nav
            class="navbar navbar-expand-lg py-1"
            id="navbar-top"
            data-navbar-soft-on-scroll="data-navbar-soft-on-scroll"
          >
            <div class="container">
              <a class="navbar-brand me-lg-auto cursor-pointer" href="/"
                ><img
                  class="w-50 w-md-100 img-fluid"
                  src="{% static 'img/logos/logoo.png' %}"
                  alt=""
              /></a>
              <button
                class="navbar-toggler border-0 pe-0"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent"
                aria-expanded="false"
                aria-label="Toggle navigation"
              >
                <span class="navbar-toggler-icon"></span>
              </button>
              <div
                class="collapse navbar-collapse"
                id="navbarSupportedContent"
                data-navbar-collapse="data-navbar-collapse"
              >
                <div
                  class="container d-lg-flex justify-content-lg-end pe-lg-0 w-lg-100"
                >
                  <form
                    class="form-inline position-relative w-lg-50 ms-lg-4 ms-xl-9 mt-3 mt-lg-0"
                    onsubmit="return false;"
                  >
                    <input
                      class="search fs-8 bg-transparent form-control"
                      type="search"
                      name="search"
                      placeholder="search..."
                    />
                    <div class="search-icon">
                      <span class="uil uil-search"></span>
                    </div>
                  </form>
                  <ul
                    class="navbar-nav mt-2 mt-lg-1 ms-lg-4 ms-xl-8 ms-2xl-9 gap-lg-x1"
                    data-navbar-nav="data-navbar-nav"
                  >
                    <li class="nav-item">
                      <a
                        class="nav-link nav-bar-item px-0"
                        href="{% url 'baseapp:home' %}"
                        title="home"
                        >Home</a
                      >
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link nav-bar-item px-0"
                        href=""
                        title="catalog"
                        >Catalog</a
                      >
                    </li>
                    <li class="nav-item">
                      <a
                        class="nav-link nav-bar-item px-0"
                        href="{% url 'baseapp:know_before' %}"
                        title="info"
                        >Animal info</a
                      >

                    </li>
                    <!-- <li class="nav-item">
                      <a
                        class="nav-link nav-bar-item px-0"
                        href="#review"
                        title="reviews"
                        >Reviews</a
                      >
                    </li> -->
                    <li class="nav-item">
                      <a
                        class="nav-link nav-bar-item px-0"
                        href="{% url 'baseapp:list_tickets' %}"
                        title="support"
                        >Support</a
                      >
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </nav>
    
          {{ room_name|json_script:"room-name" }}

        </div>
      </div>
    </div>
  </main>
</body>

<script>
  var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
  var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
    return new bootstrap.Dropdown(dropdownToggleEl);
  });

  // This ensures dropdowns close on clicking outside
  window.onclick = function(event) {
    if (!event.target.matches('.dropdown-toggle')) {
      var dropdowns = document.getElementsByClassName("dropdown-menu");
      for (var i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
          openDropdown.classList.remove('show');
        }
      }
    }
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Functionality to toggle dropdowns and update notification badge accurately
      const dropdownToggles = document.querySelectorAll('.dropdown-toggle, .notification');
      dropdownToggles.forEach(dropdownToggle => {
          dropdownToggle.addEventListener('click', function(event) {
              event.stopPropagation();
              const dropdownMenu = this.nextElementSibling;
              const isOpen = dropdownMenu.classList.contains('show');

              // Close all dropdowns
              document.querySelectorAll('.dropdown .dropdown-menu').forEach(menu => {
                  menu.classList.remove('show');
              });

              // Toggle this dropdown if it was not already open
              if (!isOpen) {
                  dropdownMenu.classList.add('show');
              }

              // If this is the notification dropdown and it's being opened, reset the badge
              if (this.classList.contains('notification') && !isOpen) {
                  this.querySelector('.badge').textContent = '0';
              }
          });
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
          document.querySelectorAll('.dropdown .dropdown-menu').forEach(menu => {
              menu.classList.remove('show');
          });
      });
  });
</script>  

<script>
  const roomName = JSON.parse(document.getElementById('room-name').textContent);

  const NotificationSocket = new WebSocket(
      'ws://'
      + window.location.host
      + '/ws/notification/'
      + roomName
      + '/'
  );

  NotificationSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      console.log(data);
      document.getElementById("notifications-dropdown").innerHTML = "<li class='dropdown-item'>" + data + "</li><hr class='dropdown-divider'>"+ document.getElementById("notifications-dropdown").innerHTML;
      document.getElementById("notification-badge").innerHTML = parseInt(document.getElementById("notification-badge").innerHTML) + 1;
  };

  NotificationSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };


</script>

</html>